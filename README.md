# Chakal.IngestSystem

A .NET 8 system for ingesting TikTok livestream data and persisting it to ClickHouse following Clean Architecture principles.

## Architecture

The solution is structured following Clean Architecture principles:

- **Chakal.Core**: Domain models and interfaces
- **Chakal.Application**: Application services and use cases
- **Chakal.Infrastructure**: Implementation of data services
- **Chakal.Infrastructure.Models**: Database model POCOs
- **Chakal.IngestSystem**: Worker service (entry point)
- **Chakal.Tests**: Unit tests

## Features

- Real-time ingestion of TikTok livestream events
- Reliable persistence to ClickHouse with bulk inserts
- Broadcast channel for real-time clients
- Health checks and Prometheus metrics
- Mock event source for debugging and testing
- Containerized with Docker and docker-compose

## Event Flow

1. Events are captured from TikTok via WebSocket (or generated by MockEventSource in debug mode)
2. Events are first sent to the PersistChannel (reliable delivery)
3. Events are then sent to the BroadcastChannel (best-effort, drop if full)
4. BulkWriter reads from PersistChannel and batches events
5. Events are inserted into ClickHouse in batches of 5,000 or every 500ms

## Configuration

The system is configured via environment variables:

| Variable | Description | Default |
|----------|-------------|---------|
| `TIKTOK_HOST` | TikTok username to capture | `mockhost` |
| `CLICKHOUSE_CONN` | ClickHouse connection string | - |
| `LOG_LEVEL` | Logging verbosity (Trace, Debug, Information, Warning, Error, Critical) | `Debug` |
| `DEBUG_MODE` | Enable mock event generation | `true` |
| `TIKTOK_COOKIES` | Optional cookies to send with TikTok requests (format `key=value;`) | - |

Example .env file:

```
TIKTOK_HOST=username
CLICKHOUSE_CONN=Host=clickhouse;Port=8123;Database=chakal;User=default;Password=Chakal123!
LOG_LEVEL=Information
DEBUG_MODE=false
TIKTOK_COOKIES=sessionid=abc123; other=val
```

## Running Locally

### Prerequisites

- .NET 8 SDK
- Docker and Docker Compose

### Using Docker Compose

1. Clone the repository
2. Create a `.env` file based on `env.sample`
3. Run the following command:

```bash
docker compose up -d
```

This will start both the ClickHouse database and the ingest system.

### Local Development

For development without Docker:

1. Start ClickHouse using Docker:

```bash
docker compose up -d clickhouse
```

2. Run the application in debug mode:

```bash
./run-local-debug.ps1
```

## Health Checks and Metrics

- Health check endpoint: `http://localhost:5000/healthz`
- Prometheus metrics: `http://localhost:5000/metrics`

Available metrics:

- `chakal_events_ingested_total`: Total number of events ingested
- `chakal_events_persisted_total`: Total number of events persisted
- `chakal_events_broadcast_dropped_total`: Total number of events dropped due to backpressure

## Database Schema

The ClickHouse database schema includes:

- Dimension tables: `dim_users`, `dim_gifts`, `dim_rooms`
- Fact tables: `fact_chat`, `fact_gift`, `fact_social`, `fact_sub`, `fact_control`, `fact_room`
- Aggregates: `agg_room_minute`

See `sql/chakal_clickhouse.sql` for the complete schema.

## License

This project is licensed under the MIT License - see the LICENSE file for details. 